<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宿舍电费监控 - 配置</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚡</text></svg>">
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        [x-cloak] { display: none !important; }
        .mobile-nav { display: none; }
        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-nav { display: flex; }
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen font-sans" x-data="dashboard()" x-init="init()">
    
    <div x-effect="if(isAdmin) loadConfig()"></div>

    <nav class="bg-white/80 backdrop-blur-md sticky top-0 z-50 shadow-sm border-b border-gray-100 desktop-nav">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="bg-blue-600 text-white p-2 rounded-lg mr-3 shadow-blue-200 shadow-md">
                        <i class="fas fa-bolt text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800 tracking-tight">宿舍电费监控</h1>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="hidden sm:flex items-center bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100">
                        <i class="far fa-clock text-indigo-400 text-xs mr-2"></i>
                        <span class="text-xs font-mono font-bold text-indigo-600 tracking-wide" x-text="currentTime"></span>
                    </div>
                    
                    <a href="/" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-xl transition-all duration-200 font-medium text-sm">
                        <i class="fas fa-home mr-2"></i>仪表盘
                    </a>
                    
                    <a href="/config" x-show="isAdmin" class="bg-blue-100 text-blue-700 px-4 py-2 rounded-xl transition-all duration-200 font-medium text-sm">
                        <i class="fas fa-cog mr-2"></i>配置
                    </a>

                    <a href="https://dorm-electricity.pages.dev/" target="_blank" rel="noopener noreferrer" class="text-gray-600 hover:bg-gray-100 px-4 py-2 rounded-xl transition-all duration-200 font-medium text-sm">
                        <i class="fas fa-question-circle mr-2"></i>帮助
                    </a>
                    
                    <button @click="isAdmin ? logout() : showAdminLogin = true" 
                            class="ml-2 w-10 h-10 flex items-center justify-center rounded-xl transition duration-200 shadow-sm border"
                            :class="isAdmin ? 'bg-green-50 text-green-600 border-green-200 hover:bg-green-100' : 'bg-white text-gray-400 border-gray-200 hover:bg-gray-50 hover:text-blue-500'"
                            :title="isAdmin ? '退出管理员' : '管理员登录'">
                        <i class="fas" :class="isAdmin ? 'fa-user-shield' : 'fa-user-cog'"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <nav class="bg-white/90 backdrop-blur shadow-lg mobile-nav flex-col border-b border-gray-100">
        <div class="flex justify-between items-center px-4 py-3">
            <div class="flex items-center">
                <div class="bg-blue-600 text-white p-1.5 rounded-lg mr-2">
                    <i class="fas fa-bolt text-sm"></i>
                </div>
                <h1 class="text-lg font-bold text-gray-800">电费监控</h1>
            </div>
            <div class="flex items-center">
                <button @click="isAdmin ? logout() : showAdminLogin = true" 
                    class="mr-3 w-8 h-8 rounded-lg flex items-center justify-center border transition-colors"
                    :class="isAdmin ? 'bg-green-50 text-green-600 border-green-200' : 'bg-white text-gray-400 border-gray-100'">
                    <i class="fas" :class="isAdmin ? 'fa-user-shield' : 'fa-user-cog text-xs'"></i>
                </button>
                <div class="flex items-center bg-indigo-50 px-2 py-1 rounded-md border border-indigo-100">
                    <span class="text-[10px] font-mono font-bold text-indigo-600 tracking-wide" x-text="currentTime"></span>
                </div>
            </div>
        </div>
        <div class="flex justify-around border-t border-gray-100 py-2">
            <a href="/" class="text-gray-400 flex flex-col items-center flex-1 py-1 rounded-lg mx-2 transition-colors">
                <i class="fas fa-home text-lg mb-0.5"></i>
                <span class="text-[10px] font-medium">仪表盘</span>
            </a>
            
            <a href="/config" x-show="isAdmin" class="text-blue-600 bg-blue-50 flex flex-col items-center flex-1 py-1 rounded-lg mx-2 transition-colors">
                <i class="fas fa-cog text-lg mb-0.5"></i>
                <span class="text-[10px] font-medium">配置</span>
            </a>

            <a href="https://dorm-electricity.pages.dev/" target="_blank" rel="noopener noreferrer" class="flex flex-col items-center flex-1 py-1 rounded-lg mx-2 text-gray-400">
                <i class="fas fa-question-circle text-lg mb-0.5"></i>
                <span class="text-[10px] font-medium">帮助</span>
            </a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-8">
        <div class="bg-white rounded-2xl shadow-sm border border-slate-100 p-6 sm:p-10 max-w-3xl mx-auto">
            <div class="flex items-center space-x-3 border-b border-gray-100 pb-6 mb-6">
                <div class="bg-blue-100 p-2.5 rounded-xl text-blue-600">
                    <i class="fas fa-sliders-h text-xl"></i>
                </div>
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">系统设置</h2>
                    <p class="text-slate-500 text-sm">调整监控频率、阈值与通知选项</p>
                </div>
            </div>

            <form @submit.prevent="saveConfig()" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">宿舍账号列表 (auth_sources)</label>
                    <p class="text-xs text-gray-400 mb-3">用于“登录按钮列表化 / 多宿舍支持”。每个 source 仅允许 A-Za-z0-9_-，大小写不敏感。新增后可去仪表盘扫码/手动输入 Cookie。</p>

                    <div class="w-full border border-gray-200 rounded-xl bg-slate-50 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition">
                        <div class="flex flex-wrap gap-2 p-3">
                            <template x-for="(src, idx) in authSourcesList" :key="src">
                                <span class="inline-flex items-center gap-1 bg-indigo-50 text-indigo-700 px-2 py-1 rounded-lg text-xs border border-indigo-200">
                                    <i class="fas fa-layer-group"></i>
                                    <span x-text="src"></span>
                                    <button type="button" class="ml-1 text-indigo-500 hover:text-indigo-700" @click="removeAuthSource(idx)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            </template>

                            <input type="text"
                                   x-model.trim="authSourceInput"
                                   @keydown.enter.prevent="addAuthSource()"
                                   placeholder="例如：x3_721b"
                                   class="flex-1 min-w-[180px] bg-transparent px-2 py-1.5 outline-none text-sm text-slate-700 placeholder:text-slate-400"/>
                            <button type="button" @click="addAuthSource()"
                                    class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-2.5 py-1.5 rounded-lg transition">
                                添加
                            </button>
                        </div>
                    </div>

                    <div class="mt-2 text-xs text-gray-400">
                        保存后会写入 config.ini 的 [system].auth_sources。
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">检测间隔 (秒)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="far fa-clock"></i></span>
                            <input type="number" x-model="config.interval" min="60" step="60"
                                class="w-full pl-10 px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white text-slate-700">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">建议设置 900 秒 (15分钟) 以上</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-2">低电量阈值 (度)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-bolt"></i></span>
                            <input type="number" x-model="config.threshold" min="0" step="0.1"
                                class="w-full pl-10 px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white text-slate-700">
                        </div>
                         <p class="text-xs text-gray-400 mt-1">低于此值将触发邮件报警</p>
                    </div>

                    <div class="sm:col-span-2">
                        <label class="block text-sm font-medium text-slate-700 mb-2">低电量告警冷却时间 (秒)</label>
                        <div class="relative">
                            <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-hourglass-half"></i></span>
                            <input type="number" x-model="config.cooldown_seconds" min="0" step="60"
                                class="w-full pl-10 px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white text-slate-700">
                        </div>
                        <p class="text-xs text-gray-400 mt-1">同一房间在冷却期内只发一次；设为 0 表示不限制（不建议）</p>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">邮件收件人</label>
                    <div class="w-full border border-gray-200 rounded-xl bg-slate-50 focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-blue-500 transition">
                        <div class="flex flex-wrap gap-2 p-3">
                            <template x-for="(mail, idx) in recipientsList" :key="mail">
                                <span class="inline-flex items-center gap-1 bg-blue-50 text-blue-700 px-2 py-1 rounded-lg text-xs border border-blue-200">
                                    <i class="far fa-envelope"></i>
                                    <span x-text="mail"></span>
                                    <button type="button" class="ml-1 text-blue-500 hover:text-blue-700" @click="removeRecipient(idx)">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </span>
                            </template>
                            <input type="email"
                                   x-model.trim="recipientInput"
                                   @keydown.enter.prevent="addRecipient()"
                                   placeholder="输入邮箱后回车添加"
                                   class="flex-1 min-w-[180px] bg-transparent px-2 py-1.5 outline-none text-sm text-slate-700 placeholder:text-slate-400"/>
                            <button type="button" @click="addRecipient()"
                                    class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-2.5 py-1.5 rounded-lg transition">
                                添加
                            </button>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">将逐个添加邮箱；保存时会同步到配置。</p>
                </div>

                <div class="pt-2">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-slate-700">宿舍/房间 → 收件人映射</label>
                    </div>
                    <p class="text-xs text-gray-400 mb-3">基于当前已抓到的房间列表和“邮件收件人”列表进行选择，支持多对多。用于“低电量告警”和“对应宿舍 Cookie 失效修复”定向通知。</p>

                    <div x-show="recipientsList.length === 0" class="text-sm text-rose-600 bg-rose-50 border border-rose-200 rounded-xl p-4">
                        请先在上方“邮件收件人”里添加至少一个邮箱，然后再配置房间映射。
                    </div>

                    <div x-show="recipientsList.length > 0" class="space-y-4">
                        <div class="bg-slate-50 border border-slate-200 rounded-xl p-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-sm font-semibold text-slate-700">当前检测到的房间</div>
                                <button type="button" @click="loadStatus()" class="text-xs text-blue-600 hover:text-blue-800">
                                    <i class="fas fa-sync-alt mr-1"></i>刷新房间列表
                                </button>
                            </div>

                            <div class="space-y-3">
                                <template x-for="roomName in availableRooms()" :key="roomName">
                                    <div class="bg-white border border-gray-200 rounded-xl p-3" x-init="roomRecipientMap[roomName] = roomRecipientMap[roomName] || []">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-sm font-medium text-slate-700" x-text="roomName"></div>
                                            <div class="text-xs text-slate-400" x-text="getRoomRecipientCount(roomName) + ' 个收件人'"></div>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                            <template x-for="mail in recipientsList" :key="mail">
                                                <label class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                    <input type="checkbox" class="accent-blue-600"
                                                           :checked="isRecipientSelected(roomName, mail)"
                                                           @change="toggleRoomRecipient(roomName, mail, $event.target.checked)">
                                                    <span class="text-slate-700" x-text="mail"></span>
                                                </label>
                                            </template>
                                        </div>
                                    </div>
                                </template>

                                <div x-show="availableRooms().length === 0" class="text-sm text-slate-400 bg-white border border-dashed border-slate-300 rounded-xl p-4">
                                    当前没有房间数据。请先确保 Cookie 正常并等待系统抓取成功。
                                </div>
                            </div>
                        </div>

                        <div x-show="unknownMappedRooms().length > 0" class="bg-amber-50 border border-amber-200 rounded-xl p-3">
                            <div class="text-sm font-semibold text-amber-800 mb-2">已保存但当前未检测到的房间</div>
                            <div class="space-y-3">
                                <template x-for="roomName in unknownMappedRooms()" :key="roomName">
                                    <div class="bg-white border border-amber-200 rounded-xl p-3" x-init="roomRecipientMap[roomName] = roomRecipientMap[roomName] || []">
                                        <div class="flex items-center justify-between mb-2">
                                            <div class="text-sm font-medium text-slate-700" x-text="roomName"></div>
                                            <div class="text-xs text-slate-400" x-text="getRoomRecipientCount(roomName) + ' 个收件人'"></div>
                                        </div>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                            <template x-for="mail in recipientsList" :key="mail">
                                                <label class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                                    <input type="checkbox" class="accent-blue-600"
                                                           :checked="isRecipientSelected(roomName, mail)"
                                                           @change="toggleRoomRecipient(roomName, mail, $event.target.checked)">
                                                    <span class="text-slate-700" x-text="mail"></span>
                                                </label>
                                            </template>
                                        </div>
                                        <p class="text-xs text-amber-700 mt-2">提示：该房间当前未出现在仪表盘数据中，但映射仍会被保留。</p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-2">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-slate-700">Source → 默认收件人 / 显示名称</label>
                    </div>
                    <p class="text-xs text-gray-400 mb-3">当某个房间未配置映射时，将按 source 默认收件人发送告警（新模式默认）。显示名称用于仪表盘按钮展示。</p>

                    <div x-show="recipientsList.length === 0" class="text-sm text-rose-600 bg-rose-50 border border-rose-200 rounded-xl p-4">
                        请先在上方“邮件收件人”里添加至少一个邮箱，然后再配置 source 默认收件人。
                    </div>

                    <div x-show="recipientsList.length > 0" class="space-y-3">
                        <template x-for="src in availableSources()" :key="src">
                            <div class="bg-white border border-gray-200 rounded-xl p-3" 
                                 x-init="sourceRecipientMap[src] = sourceRecipientMap[src] || []; authLabelsMap[src] = (authLabelsMap[src] || '')">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="text-sm font-medium text-slate-700" x-text="src"></div>
                                    <div class="text-xs text-slate-400" x-text="getSourceRecipientCount(src) + ' 个收件人'"></div>
                                </div>

                                <label class="block text-xs text-slate-500 mb-1">显示名称（可选）</label>
                                <input type="text" x-model.trim="authLabelsMap[src]"
                                       class="w-full px-3 py-2 border border-gray-200 rounded-lg bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition text-sm text-slate-700"
                                       placeholder="例如：西三721B宿舍">

                                <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                                    <template x-for="mail in recipientsList" :key="mail">
                                        <label class="flex items-center gap-2 bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm">
                                            <input type="checkbox" class="accent-blue-600"
                                                   :checked="isSourceRecipientSelected(src, mail)"
                                                   @change="toggleSourceRecipient(src, mail, $event.target.checked)">
                                            <span class="text-slate-700" x-text="mail"></span>
                                        </label>
                                    </template>
                                </div>
                            </div>
                        </template>

                        <div x-show="availableSources().length === 0" class="text-sm text-slate-400 bg-white border border-dashed border-slate-300 rounded-xl p-4">
                            当前没有配置任何 source。
                        </div>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-2">服务器IP (用于链接)</label>
                    <div class="relative">
                         <span class="absolute left-3 top-2.5 text-gray-400"><i class="fas fa-network-wired"></i></span>
                         <input type="text" x-model="config.server_ip" 
                               class="w-full pl-10 px-3 py-2.5 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition bg-slate-50 focus:bg-white text-slate-700">
                    </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-3 sm:gap-4 pt-4 border-t border-gray-100">
                    <button type="button" @click="openTestEmailModal()"
                            class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-5 py-2.5 rounded-xl transition font-medium flex items-center justify-center">
                        <i class="fas fa-paper-plane mr-2 text-gray-400"></i>测试邮件
                    </button>
                    <button type="submit"
                            class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-xl transition font-medium shadow-lg shadow-blue-200 flex items-center justify-center">
                        <i class="fas fa-save mr-2"></i>保存配置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div x-show="showAdminLogin" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.self="showAdminLogin = false">
        <div class="bg-white rounded-xl shadow-xl max-w-sm w-full p-6">
            <h3 class="text-xl font-bold mb-4 text-center">🔐 管理员登录</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Access Token</label>
                    <input type="password" x-model="adminInputToken"
                           @keyup.enter="loginAdmin()"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 text-sm">
                </div>
                <button @click="loginAdmin()"
                        class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition font-medium">
                    验证
                </button>
            </div>
        </div>
    </div>

    <div x-show="showTestEmailModal" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" @click.self="showTestEmailModal = false">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
            <h3 class="text-lg font-bold mb-4">发送测试邮件</h3>
            <div class="space-y-4">
                <div class="flex items-center gap-4">
                    <label class="inline-flex items-center gap-2 text-sm">
                        <input type="radio" class="accent-blue-600" value="select" x-model="testEmailMode">
                        <span>从收件人列表选择</span>
                    </label>
                    <label class="inline-flex items-center gap-2 text-sm">
                        <input type="radio" class="accent-blue-600" value="custom" x-model="testEmailMode">
                        <span>自定义邮箱</span>
                    </label>
                </div>
                <div x-show="testEmailMode === 'select'" class="space-y-2">
                    <div class="flex items-center justify-between">
                        <label class="block text-sm text-slate-600">选择收件人（可多选）</label>
                        <div class="flex gap-2">
                            <button type="button" @click="selectedRecipients = recipientsList.slice()" class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-2.5 py-1.5 rounded-lg transition">
                                全选
                            </button>
                            <button type="button" @click="selectedRecipients = []" class="text-xs bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-2.5 py-1.5 rounded-lg transition">
                                清空
                            </button>
                        </div>
                    </div>

                    <div class="w-full border border-gray-200 rounded-xl bg-slate-50 p-3 max-h-56 overflow-auto">
                        <div class="space-y-2">
                            <template x-for="mail in recipientsList" :key="mail">
                                <label class="flex items-center gap-2 bg-white border border-gray-200 rounded-lg px-3 py-2">
                                    <input type="checkbox" class="accent-blue-600" :value="mail" x-model="selectedRecipients">
                                    <span class="text-sm text-slate-700" x-text="mail"></span>
                                </label>
                            </template>
                        </div>
                        <p x-show="recipientsList.length === 0" class="text-xs text-rose-500">当前列表为空，请先添加收件人。</p>
                    </div>

                    <p class="text-xs text-gray-400">已选择 <span class="font-mono" x-text="selectedRecipients.length"></span> 个</p>
                </div>
                <div x-show="testEmailMode === 'custom'" class="space-y-2">
                    <label class="block text-sm text-slate-600">邮箱地址</label>
                    <input type="email" x-model.trim="customRecipientEmail" placeholder="someone@example.com"
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm"/>
                </div>

                <div class="flex gap-3 pt-2">
                    <button @click="showTestEmailModal = false" type="button" class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 px-4 py-2 rounded-lg text-sm">取消</button>
                    <button @click="sendTestEmail()" type="button" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm">发送</button>
                </div>
                <p class="text-xs text-gray-400">提示：可选择一个或多个邮箱发送测试邮件。</p>
            </div>
        </div>
    </div>

    <div x-show="toast.show" x-transition class="fixed bottom-8 right-8 text-white px-6 py-4 rounded-lg shadow-lg z-50"
        :class="toast.type === 'success' ? 'bg-green-500' : 'bg-red-500'">
        <span x-text="toast.message"></span>
    </div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html>